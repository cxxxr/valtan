name: SACLA Tests

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Setup Quicklisp
        run: |
          nix develop --command bash -c '
            curl -O https://beta.quicklisp.org/quicklisp.lisp
            sbcl --non-interactive \
              --load quicklisp.lisp \
              --eval "(quicklisp-quickstart:install)" \
              --eval "(quit)"
          '

      - name: Build valtan
        run: |
          nix develop --command bash -c '
            sbcl --non-interactive \
              --load ~/quicklisp/setup.lisp \
              --eval "(ql:quickload :valtan-cli)" \
              --eval "(asdf:make :valtan-cli/executable)" \
              --eval "(quit)"
          '

      - name: Build tests
        run: |
          nix develop --command bash -c '
            cd tests
            npm install
            ../valtan build tests.system
            npx vite build
          '

      - name: Run SACLA tests
        id: run-tests
        run: |
          nix develop --command bash -c '
            cd tests
            node dist/tests.js --quiet 2>&1 | tee test-output.txt

            PASS=$(grep "TOTAL:" test-output.txt | sed "s/.*Pass=\([0-9]*\).*/\1/")
            FAIL=$(grep "TOTAL:" test-output.txt | sed "s/.*Fail=\([0-9]*\).*/\1/")
            RATE=$(grep "Pass Rate:" test-output.txt | sed "s/.*: \([0-9]*\)%.*/\1/")

            echo "pass=$PASS" >> $GITHUB_OUTPUT
            echo "fail=$FAIL" >> $GITHUB_OUTPUT
            echo "rate=$RATE" >> $GITHUB_OUTPUT

            # Generate visual progress bar
            make_bar() {
              local rate=$1
              local filled=$((rate / 10))
              local empty=$((10 - filled))
              local bar=""
              for ((i=0; i<filled; i++)); do bar+="â–ˆ"; done
              for ((i=0; i<empty; i++)); do bar+="â–‘"; done
              echo "$bar"
            }

            # Parse results into categorized files
            PERFECT=""
            NEEDS_WORK=""
            CRITICAL=""

            while IFS= read -r line; do
              file=$(echo "$line" | sed "s/^--- //" | awk -F: "{print \$1}")
              pass=$(echo "$line" | sed "s/.*Pass=\\([0-9]*\\).*/\\1/")
              fail=$(echo "$line" | sed "s/.*Fail=\\([0-9]*\\).*/\\1/")
              total=$((pass + fail))
              if [ "$total" -gt 0 ]; then
                rate=$((pass * 100 / total))
              else
                rate=0
              fi

              bar=$(make_bar $rate)

              if [ "$rate" -eq 100 ]; then
                PERFECT+="| $file | $bar | $rate% | $pass |\\n"
              elif [ "$rate" -ge 50 ]; then
                NEEDS_WORK+="| $file | $bar | $rate% | $fail |\\n"
              else
                CRITICAL+="| $file | $bar | $rate% | $fail |\\n"
              fi
            done < <(grep -E "^--- (must-|should-|desirable-)" test-output.txt)

            # Overall progress bar
            OVERALL_BAR=$(make_bar $RATE)

            # Write summary
            echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Overall: $RATE% ($PASS/$((PASS+FAIL)))** \`$OVERALL_BAR\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Perfect tests (table)
            if [ -n "$PERFECT" ]; then
              PERFECT_COUNT=$(echo -e "$PERFECT" | grep -c "^|" || true)
              echo "### âœ… Perfect ($PERFECT_COUNT tests)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Test | Progress | Rate | Pass |" >> $GITHUB_STEP_SUMMARY
              echo "|:-----|:--------:|-----:|-----:|" >> $GITHUB_STEP_SUMMARY
              echo -e "$PERFECT" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            # Needs work tests (table)
            if [ -n "$NEEDS_WORK" ]; then
              NEEDS_COUNT=$(echo -e "$NEEDS_WORK" | grep -c "^|" || true)
              echo "### âš ï¸ Needs Work ($NEEDS_COUNT tests)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Test | Progress | Rate | Fail |" >> $GITHUB_STEP_SUMMARY
              echo "|:-----|:--------:|-----:|-----:|" >> $GITHUB_STEP_SUMMARY
              echo -e "$NEEDS_WORK" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            # Critical tests (table)
            if [ -n "$CRITICAL" ]; then
              CRITICAL_COUNT=$(echo -e "$CRITICAL" | grep -c "^|" || true)
              echo "### âŒ Critical ($CRITICAL_COUNT tests)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Test | Progress | Rate | Fail |" >> $GITHUB_STEP_SUMMARY
              echo "|:-----|:--------:|-----:|-----:|" >> $GITHUB_STEP_SUMMARY
              echo -e "$CRITICAL" >> $GITHUB_STEP_SUMMARY
            fi
          '

      - name: Check for regressions
        run: |
          RATE=${{ steps.run-tests.outputs.rate }}
          if [ "$RATE" -lt 85 ]; then
            echo "Test pass rate ($RATE%) is below threshold (85%)"
            exit 1
          fi
          echo "Test pass rate: $RATE% (threshold: 85%)"
